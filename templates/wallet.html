{% extends "base.html" %}

{% block hero_icon %}
  <i data-lucide="wallet" class="w-5 h-5 mx-auto mb-4 text-neutral-900"></i>
{% endblock %}

{% block hero_buttons %}
  <a href="/deposit" class="inline-block mt-4 px-4 py-2 bg-neutral-900 text-white rounded-lg hover:bg-neutral-700 text-sm">Deposit</a>
  <a href="/withdraw" class="inline-block mt-4 px-4 py-2 border border-neutral-900 rounded-lg hover:bg-neutral-100 text-sm">Withdraw</a>
{% endblock %}

{% block content %}
  <!-- Responsive 3-column layout, Balance Breakdown column is narrower -->
  <div class="grid grid-cols-1 md:grid-cols-[1.4fr_1fr_1.4fr] gap-6">

    <!-- Column 1: Wallet Summary -->
    <div class="p-6 bg-white">
      <h2 class="font-medium text-neutral-600 mb-1">Total Balance</h2>
      <p class="text-3xl font-bold">{{ formatted_balance }}</p>

      <div class="mt-6">
        <h3 class="font-medium text-neutral-600 mb-1">Deposit Address</h3>
        {% if deposit_address %}
          <div class="flex items-center space-x-2">
            <span class="text-xs break-all">{{ deposit_address }}</span>
            <button onclick="copyAddress('{{ deposit_address }}', this)"
                    class="relative text-neutral-500 hover:text-neutral-800 transition-transform hover:scale-110 active:scale-95">
              <i data-lucide="copy" class="w-4 h-4"></i>
              <span class="absolute -top-6 left-1/2 -translate-x-1/2 px-2 py-1 text-xs bg-neutral-800 text-white rounded opacity-0 pointer-events-none transition-opacity duration-300 tooltip">Copied!</span>
            </button>
          </div>
          <p class="text-xs mt-2 text-neutral-500">Network: Arbitrum Sepolia</p>
          <p class="text-xs mt-1 text-red-500">⚠️ Deposit USDC only. Any other tokens will be lost.</p>
        {% else %}
          <p class="text-sm text-neutral-500">No deposit address available</p>
        {% endif %}
      </div>

      {% if qr_code_base64 %}
        <div class="mt-4 flex justify-start">
          <img src="data:image/png;base64,{{ qr_code_base64 }}" alt="Deposit QR Code" class="w-28 h-28">
        </div>
      {% endif %}
    </div>

    <!-- Column 2: Balance Breakdown (narrower) -->
    <div class="p-6 bg-white md:border-l md:border-neutral-200 md:pl-6 flex flex-col items-center">
      <h2 class="font-medium text-neutral-600 mb-4 text-center">Balance Breakdown</h2>

      <!-- Donut with smooth animation -->
      <div class="flex items-center justify-center">
        <div class="relative w-32 h-32 rounded-full transition-[background] duration-700 ease-in-out"
             style="background: conic-gradient(#3b82f6 {{ donut.funding_pct }}%, #22c55e 0);">
          <div class="absolute inset-4 bg-white rounded-full flex items-center justify-center">
            <div class="text-center leading-tight">
              <div class="text-sm font-semibold text-neutral-700">{{ donut.total_formatted }}</div>
              <div class="text-[10px] text-neutral-500 tracking-wide">USDC</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Key -->
      <div class="mt-3 text-xs text-neutral-600 space-y-1 text-center">
        <p>
          <span class="inline-block w-3 h-3 bg-blue-500 rounded-sm mr-1"></span>
          Funding Balance ({{ funding_balance }})
        </p>
        <p>
          <span class="inline-block w-3 h-3 bg-green-500 rounded-sm mr-1"></span>
          Hyperliquid Balance ({{ hyperliquid_balance }})
        </p>
      </div>
    </div>

    <!-- Column 3: Transfer Form (Unified) -->
    <div class="p-6 bg-white md:border-l md:border-neutral-200 md:pl-6">
      <h2 class="font-medium text-neutral-600 mb-4">Transfer USDC</h2>
      
      <form method="POST" action="/transfer" class="space-y-4" id="transferForm">
        <!-- From / To with switch -->
        <div class="flex items-center justify-between space-x-3">
          <div class="flex-1">
            <label class="block text-xs font-medium text-neutral-600 mb-1">From</label>
            <select id="fromSelect" name="from"
                    class="w-full border rounded-lg px-3 py-2 text-sm bg-neutral-50 focus:outline-none focus:ring-2 focus:ring-neutral-800">
              <option value="Hyperliquid">Hyperliquid</option>
              <option value="Arbitrum Sepolia">Arbitrum Sepolia</option>
            </select>
          </div>
          <!-- switch perfectly aligned -->
          <button type="button" id="switchBtn"
                  class="flex-shrink-0 self-center w-7 h-7 flex items-center justify-center rounded-full border bg-white hover:bg-neutral-100">
            <i data-lucide="repeat" class="w-4 h-4 text-neutral-700"></i>
          </button>
          <div class="flex-1">
            <label class="block text-xs font-medium text-neutral-600 mb-1">To</label>
            <select id="toSelect" name="to"
                    class="w-full border rounded-lg px-3 py-2 text-sm bg-neutral-50 focus:outline-none focus:ring-2 focus:ring-neutral-800">
              <option value="Arbitrum Sepolia">Arbitrum Sepolia</option>
              <option value="Hyperliquid">Hyperliquid</option>
            </select>
          </div>
        </div>

        <!-- Amount input -->
        <div>
          <label class="block text-xs font-medium text-neutral-600 mb-1">Amount</label>
          <div class="relative">
            <input type="number" step="0.01" min="0" id="amountInput" name="amount"
                   placeholder="Enter amount in USDC"
                   class="w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-neutral-800 pr-12">
            <button type="button" id="maxBtn"
                    class="absolute right-2 top-1/2 -translate-y-1/2 text-xs text-blue-600 hover:underline">
              Max <span id="maxValue">{{ funding_balance }}</span>
            </button>
          </div>
        </div>

        <!-- Transfer button -->
        <button type="button" id="transferBtn"
                class="w-full bg-neutral-900 text-white py-2 rounded-lg hover:bg-neutral-700 text-sm disabled:opacity-50 disabled:cursor-not-allowed">
          Transfer
        </button>
      </form>

      <!-- Rules text -->
      <p id="rulesText" class="text-xs mt-3 text-neutral-500">
        You must move funds into Hyperliquid to start our custom strategies.
      </p>
    </div>
  </div>

  <!-- Modal -->
  <div id="confirmModal"
       class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg p-6 max-w-sm w-full">
      <h3 class="text-lg font-semibold text-neutral-800 mb-2">Confirm Transfer</h3>
      <p class="text-sm text-neutral-600 mb-4">
        Are you sure you want to proceed with this transfer?
      </p>
      <div class="flex justify-end space-x-3">
        <button id="cancelModal"
                class="px-4 py-2 border rounded-lg text-sm text-neutral-700 hover:bg-neutral-100">
          No
        </button>
        <button id="confirmModalYes"
                class="px-4 py-2 bg-neutral-900 text-white rounded-lg text-sm hover:bg-neutral-700">
          Yes
        </button>
      </div>
    </div>
  </div>

    <!-- JS Logic -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const fromSelect = document.getElementById("fromSelect");
      const toSelect = document.getElementById("toSelect");
      const switchBtn = document.getElementById("switchBtn");
      const amountInput = document.getElementById("amountInput");
      const maxBtn = document.getElementById("maxBtn");
      const maxValueSpan = document.getElementById("maxValue");
      const transferBtn = document.getElementById("transferBtn");
      const rulesText = document.getElementById("rulesText");

      // Modal elements
      const confirmModal = document.getElementById("confirmModal");
      const cancelModal = document.getElementById("cancelModal");
      const confirmModalYes = document.getElementById("confirmModalYes");
      const form = document.getElementById("transferForm");

      // balances passed from Flask
      const balances = {
        "Hyperliquid": {{ hyperliquid_balance | default(0) }},
        "Arbitrum Sepolia": {{ funding_balance | default(0) }}
      };

      function updateMax() {
        const from = fromSelect.value;
        const maxValue = balances[from] || 0;
        maxValueSpan.textContent = maxValue.toFixed(2);
        if (parseFloat(amountInput.value) > maxValue) {
          amountInput.value = maxValue.toFixed(2);
        }
        toggleTransfer(maxValue);
      }

      function toggleTransfer(maxValue) {
        if (maxValue < 5) {
          transferBtn.disabled = true;
          rulesText.textContent = "Minimum transfer must be at least 5 USDC.";
          rulesText.classList.add("text-red-500");
        } else {
          transferBtn.disabled = false;
          rulesText.textContent = "You must move funds into Hyperliquid to start our custom strategies.";
          rulesText.classList.remove("text-red-500");
        }
      }

      function preventSameSelection() {
        if (fromSelect.value === toSelect.value) {
          toSelect.value = fromSelect.value === "Hyperliquid" ? "Arbitrum Sepolia" : "Hyperliquid";
        }
        updateMax();
      }

      switchBtn.addEventListener("click", () => {
        const temp = fromSelect.value;
        fromSelect.value = toSelect.value;
        toSelect.value = temp;
        updateMax();
      });

      maxBtn.addEventListener("click", () => {
        amountInput.value = maxValueSpan.textContent;
      });

      fromSelect.addEventListener("change", preventSameSelection);
      toSelect.addEventListener("change", preventSameSelection);

      amountInput.addEventListener("input", () => {
        const maxValue = parseFloat(maxValueSpan.textContent);
        if (parseFloat(amountInput.value) > maxValue) {
          amountInput.value = maxValue.toFixed(2);
        }
      });

      // Modal open
      transferBtn.addEventListener("click", () => {
        confirmModal.classList.remove("hidden");
        confirmModal.classList.add("flex");
      });

      // Modal cancel
      cancelModal.addEventListener("click", () => {
        confirmModal.classList.add("hidden");
        confirmModal.classList.remove("flex");
      });

      // Modal confirm -> submit form
      confirmModalYes.addEventListener("click", () => {
        form.submit();
      });

      updateMax();
    });

    // Copy address with tooltip animation
    function copyAddress(addr, el) {
      navigator.clipboard.writeText(addr).then(() => {
        const tooltip = el.querySelector(".tooltip");
        tooltip.classList.remove("opacity-0");
        tooltip.classList.add("opacity-100");

        setTimeout(() => {
          tooltip.classList.remove("opacity-100");
          tooltip.classList.add("opacity-0");
        }, 1200);
      });
    }
  </script>

{% endblock %}
